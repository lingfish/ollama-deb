name: Update repository

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'GitHub release tag to download (.deb from). Leave blank for latest'
        required: false
        default: ''
#  workflow_run:
#    workflows: [Build new release v2]
#    types: [completed]
  release:
    types: [released]

jobs:
  update-repo:
    runs-on: ubuntu-latest
    #if: github.event_name == 'workflow_dispatch' || (github.event_name == 'release' && github.event.action == 'published')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Install repo for newer reprepro
        uses: gerlero/add-apt-repository@v1
        with:
          uri: https://raw.githubusercontent.com/Aetherinox/proteus-apt-repo/main
          key: https://github.com/Aetherinox.gpg

      - name: Install reprepro
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro tree
          reprepro --version

      - name: Create dirs if needed
        run: |
          mkdir -p debian-repo/{apt,deb,reprepro/{conf,db}}
          mkdir -p debian-repo/deb/bookworm

      - name: Download latest release or specified tag
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ github.event.inputs.release_tag }}
        run: |
          cd debian-repo/deb/bookworm
          if [ -n "$RELEASE_TAG" ]; then
            echo "Downloading tag $RELEASE_TAG..."
            gh release download "$RELEASE_TAG" --pattern '*.deb'
          else
            echo "Downloading latest release..."
            gh release download --pattern '*.deb'
          fi
          cd -
          tree

      - name: Run reprepro
        run: |
          cd debian-repo
          current=`pwd`
          reprepro=$current/reprepro
          echo $current
          echo $reprepro
          cd apt
          reprepro --dbdir $reprepro/db --confdir $reprepro/conf translatelegacyreferences
          reprepro --dbdir $reprepro/db --confdir $reprepro/conf -C main includedeb bookworm $current/deb/bookworm/*deb
          cd dists/bookworm
          cat Release | gpg -s --default-key 1C9E802275991A570F4BDBEB91A978214AE92757 -abs > Release.gpg
          rm -rf $current/deb

      - name: Checkin new stuff
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git add debian-repo/reprepro
          git commit -m "Update ollama to ${GITHUB_REF_NAME}"
          git push

      - name: Push to R2
        uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET }}
          source-dir: debian-repo
          destination-dir: ./
